# -*- coding: utf-8 -*-
"""process_and _split_imgs.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1h3Cj0yoy81wSTg0uH02bGiJQO_WnnoGE
"""

# Libraries
import numpy as np
import torch
import torch.nn as nn
import math
import os
import shutil
import cv2
from torchvision import datasets
from torchvision import transforms
from torchvision.datasets import ImageFolder
from torch.utils.data import DataLoader, random_split, ConcatDataset

# full dataset path
data_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE/'
dataset = ImageFolder(data_dir)

num_img = len(dataset)

# 80/10/10 split
train_size = math.ceil(num_img*.8)
val_size = int((num_img - train_size)/2)
test_size = int(num_img - train_size - val_size)

# split dataset into train/test/val with correct split
train_dataset, val_dataset, test_dataset = random_split(dataset, [train_size, val_size, test_size])

# function to sort images into correct class directories
def move_img(full_data, split_data, target_dir):
  for i in split_data.indices:
    # get path and label from ImageFolder object
    full_path = full_data.imgs[i][0]
    label = full_data.imgs[i][1]

    # get filename
    path, filename = os.path.split(full_path)

    # get class label
    shorter, number = os.path.split(path)
    assert int(number) == label

    # move to correct target directory by label
    target_path = target_dir + str(label) + '/' + filename
    shutil.move(full_path, target_path)

# function to save indices of images in train, test, val sets
def save_list(dir, data_list):
  path = open(dir,'w')
  for item in data_list:
    path.write(str(item) + '\n')
  path.close()

# target directories
train_target_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_ROI/train/'
val_target_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_ROI/val/'
test_target_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_ROI/test/'

# sort each split set into directories by class labels
move_img(dataset, train_dataset, train_target_dir)
move_img(dataset, val_dataset, val_target_dir)
move_img(dataset, test_dataset, test_target_dir)

# paths to save indices
data_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_docs/RIM-ONE_data_paths.txt'
train_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_docs/RIM-ONE_train_indices.txt'
val_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_docs/RIM-ONE_val_indices.txt'
test_dir = '/content/drive/MyDrive/ORF 498/RIM-ONE_docs/RIM-ONE_test_indices.txt'

# save indices of each split set
save_list(data_dir, dataset.imgs)
save_list(train_dir, train_dataset.indices)
save_list(val_dir, val_dataset.indices)
save_list(test_dir, test_dataset.indices)